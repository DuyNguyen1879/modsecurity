# ---------------------------------------------------------------
# Sliqua WAF based on Comodo ModSecurity Rules
# Copyright (C) 2016 Sliqua Enterprise Hosting, Inc.
# Copyright (C) 2015 Comodo Security solutions All rights reserved.
# Please see the enclosed LICENCE file for full details.
# ---------------------------------------------------------------
# This is a FILE CONTAINING CHANGED or MODIFIED RULES FROM THE:
# OWASP ModSecurity Core Rule Set (CRS)
# Comodo Web Application Firewall
# ----------------------------------------------------------------

SecRule ARGS_POST:/player_settings\[presentation\]\[height\]/|ARGS_POST:/player_settings\[presentation\]\[width\]/ "[^0-9]" \
	"id:221270,rev:1,chain,msg:'COMODO WAF: Blocking XSS in CVE-2013-4380|%{tx.domain}|%{tx.mode}',phase:2,deny,log,t:'none',t:'htmlEntityDecode',t:'urlDecodeUni',t:'lowercase'"
SecRule REQUEST_URI "@contains mediafront/preset/admin" \
	"t:'none',t:'urlDecodeUni',t:'lowercase'"

SecRule ARGS_POST:import "@rx \b(?:(?!array)(?!flags\[))(\$)*([a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*\s*(\[.*|\(.*))" \
	"id:221280,rev:1,chain,msg:'COMODO WAF: Blocking eval injection CVE-2014-3453|%{tx.domain}|%{tx.mode}',phase:2,deny,status:403,log,t:'none',t:'urlDecodeUni',t:'lowercase'"
SecRule REQUEST_URI "@contains admin/structure/flags/import" \
	"t:'none',t:'urlDecodeUni',t:'lowercase'"

SecRule REQUEST_URI "@pm q=node/add/ q=comment/reply/" \
	"id:221970,rev:1,chain,msg:'COMODO WAF: Reflected XSS attack (CVE-2014-5022)|%{tx.domain}|%{tx.mode}',phase:2,deny,status:403,log,t:'none',t:'urlDecodeUni',t:'htmlEntityDecode',t:'lowercase',t:'normalisePath',t:'removeWhitespace'"
SecRule ARGS_POST:body[und][0][value]|ARGS_POST:comment_body[und][0][value] "@contains <" \
	"t:'none',t:'urlDecodeUni',t:'htmlEntityDecode',t:'lowercase'"

SecRule REQUEST_URI "@pm q=node/add/" \
	"id:221971,rev:1,chain,msg:'COMODO WAF: Reflected XSS attack (CVE-2014-5022)|%{tx.domain}|%{tx.mode}',phase:2,deny,status:403,log,t:'none',t:'urlDecodeUni',t:'htmlEntityDecode',t:'lowercase',t:'normalisePath',t:'removeWhitespace'"
SecRule STREAM_INPUT_BODY "@pm < >" \
	"t:'none',t:'urlDecodeUni',t:'htmlEntityDecode',t:'lowercase'"

SecRule ARGS:q|REQUEST_FILENAME "@contains redhen/contact" \
	"id:231000,rev:2,chain,msg:'COMODO WAF: Multiple XSS vulnerabilities in the Redhen module 7.x-1.x before 7.x-1.11 for Drupal (CVE-2016-1913)|%{tx.domain}|%{tx.mode}',phase:2,deny,status:403,log,t:'none',t:'urlDecodeUni',t:'normalisePath',t:'lowercase'"
SecRule ARGS:first_name|ARGS:middle_name|ARGS:last_name "@contains <" \
	"chain,t:'none',t:'urlDecodeUni'"
SecRule REQUEST_COOKIES_NAMES "@rx ^sess[0-9a-f]{32}$" \
	"t:'none',t:'lowercase'"

SecRule ARGS:q "@contains structure/redhen/engagement_scores/" \
	"id:231001,rev:2,chain,msg:'COMODO WAF: Multiple XSS vulnerabilities in the Redhen module 7.x-1.x before 7.x-1.11 for Drupal (CVE-2016-1913)|%{tx.domain}|%{tx.mode}',phase:2,deny,status:403,log,t:'none',t:'urlDecodeUni',t:'normalisePathWin',t:'lowercase'"
SecRule &ARGS:score "@ge 1" \
	"chain,t:'none'"
SecRule ARGS:label "@contains <" \
	"chain,t:'none',t:'urlDecodeUni'"
SecRule REQUEST_COOKIES_NAMES "@rx ^sess[0-9a-f]{32}$" \
	"t:'none',t:'lowercase'"

SecRule ARGS:q "@pm structure/taxonomy/note_type/ taxonomy/term" \
	"id:231002,rev:2,chain,msg:'COMODO WAF: Multiple XSS vulnerabilities in the Redhen module 7.x-1.x before 7.x-1.11 for Drupal (CVE-2016-1913)|%{tx.domain}|%{tx.mode}',phase:2,deny,status:403,log,t:'none',t:'urlDecodeUni',t:'normalisePathWin',t:'lowercase'"
SecRule ARGS:name "@contains <" \
	"chain,t:'none',t:'urlDecodeUni'"
SecRule REQUEST_COOKIES_NAMES "@rx ^sess[0-9a-f]{32}$" \
	"t:'none',t:'lowercase'"

SecRule REQUEST_FILENAME "@endsWith xmlrpc.php" \
	"id:231010,rev:2,chain,msg:'COMODO WAF: Set request body processor to be XML|%{tx.domain}|%{tx.mode}',phase:1,pass,setvar:'TX.drupal_xmlrpc=1',nolog,ctl:'requestBodyProcessor=XML',t:'none',t:'lowercase'"
SecRule REQUEST_HEADERS:Content-Type "@within text/xml application/xml" \
	"t:'none',t:'normalisePath',t:'lowercase'"

SecRule TX:drupal_xmlrpc "@eq 1" \
	"id:231011,rev:2,chain,msg:'COMODO WAF: Brute-Force Amplification in Drupal 6.x before 6.38 and 7.x before 7.43 (CVE-2016-3163)|%{tx.domain}|%{tx.mode}',phase:2,deny,status:403,log,t:'none'"
SecRule REQBODY_ERROR "@eq 0" \
	"chain,t:'none'"
SecRule XML://methodName/text() "@contains system.multicall" \
	"chain,t:'none',t:'lowercase'"
SecRule &XML://member[*][name='methodName'] "@ge 10" \
	"t:'none'"

SecRule ARGS:q|REQUEST_FILENAME "@contains cms-updater" \
	"id:241790,rev:2,chain,msg:'COMODO WAF: XSS vulnerability in the CMS Updater module 7.x-1.x before 7.x-1.3 for Drupal (CVE-2015-7307)|%{tx.domain}|%{tx.mode}',phase:2,deny,status:403,log,t:'none',t:'lowercase'"
SecRule ARGS_GET:cmsu_payment_url "@rx \"" \
	"chain,t:'none',t:'urlDecodeUni'"
SecRule REQUEST_COOKIES_NAMES "@rx ^sess[0-9a-f]{32}$" \
	"t:'none',t:'lowercase'"

SecRule ARGS:pp "@contains =" \
	"id:241910,rev:2,chain,msg:'COMODO WAF: The Prepopulate module 7.x-2.x before 7.x-2.1 for Drupal allows remote attackers to modify the REQUEST superglobal array, and consequently have unspecified impact, via a base64-encoded pp parameter (CVE-2016-3187)|%{tx.domain}|%{tx.mode}',phase:2,deny,status:403,setvar:'TX.pp=%{ARGS:pp}',setvar:'TX.drupal_pp=%{MATCHED_VAR}',log,t:'none',t:'urlDecodeUni',t:'base64DecodeExt'"
SecRule TX:drupal_pp "!@streq %{ARGS:pp}" \
	"t:'none',t:'urlDecodeUni'"

SecRule ARGS:destination|ARGS:edit[destination] "@contains //" \
	"id:241860,rev:3,chain,msg:'COMODO WAF: Open redirect vulnerability in Drupal 6.x before 6.38 (CVE-2016-3167)|%{tx.domain}|%{tx.mode}',phase:3,deny,status:403,log,t:'none',t:'urlDecodeUni'"
SecRule RESPONSE_HEADERS:Set-Cookie "@rx ^sess[0-9a-f]{32}\=[0-9a-z]{26}\;" \
	"t:'none',t:'lowercase'"

SecRule ARGS:q|REQUEST_FILENAME "@contains mass_contact" \
	"id:231020,rev:1,chain,msg:'COMODO WAF: XSS vulnerability in the Mass Contact module 6.x-1.x before 6.x-1.6 and 7.x-1.x before 7.x-1.1 for Drupal (CVE-2015-6807)|%{tx.domain}|%{tx.mode}',phase:2,deny,status:403,log,t:'none',t:'lowercase'"
SecRule ARGS_POST:form_id "@streq mass_contact_admin_edit" \
	"chain,t:'none'"
SecRule ARGS_POST_NAMES "@contains recipients[mass_contact_role]" \
	"chain,t:'none',t:'urlDecodeUni'"
SecRule ARGS_POST:category "@contains <" \
	"chain,t:'none',t:'urlDecodeUni'"
SecRule REQUEST_COOKIES_NAMES "@rx ^sess[0-9a-f]{32}$" \
	"t:'none',t:'lowercase'"

SecRule ARGS_POST:form_id "@within time_tracker_activity_table_form time_tracker_time_entry_form" \
	"id:231030,rev:1,chain,msg:'COMODO WAF: Multiple XSS vulnerabilities in the Time Tracker module 7.x-1.x before 7.x-1.4 for Drupal (CVE-2015-6751)|%{tx.domain}|%{tx.mode}',phase:2,deny,status:403,log,t:'none'"
SecRule ARGS_POST:note|ARGS_POST:/activities\[\d+\]\[name\]/|ARGS_POST:add_new_activity[new_activity_name] "@contains <" \
	"chain,t:'none',t:'urlDecodeUni'"
SecRule REQUEST_COOKIES_NAMES "@rx ^sess[0-9a-f]{32}$" \
	"t:'none',t:'lowercase'"

SecRule TX:drupal "@eq 1" \
	"id:231050,rev:1,chain,msg:'COMODO WAF: XSS vulnerability in the administration interface in the Path Breadcrumbs module 7.x-3.x before 7.x-3.3 for Drupal (CVE-2015-6754)|%{tx.domain}|%{tx.mode}',phase:2,deny,status:403,log,t:'none'"
SecRule ARGS_POST:form_id "@within path_breadcrumbs_ui_edit_form path_breadcrumbs_ui_add_form" \
	"chain,t:'none'"
SecRule ARGS_POST:name "@contains <" \
	"chain,t:'none',t:'urlDecodeUni'"
SecRule ARGS:q|REQUEST_FILENAME "@contains system/ajax" \
	"t:'none',t:'urlDecodeUni',t:'normalisePath'"

SecRule &TX:drupal "@ge 1" \
	"id:231060,rev:1,chain,msg:'COMODO WAF: XSS vulnerability in the Block Class module 7.x-2.x before 7.x-2.2 for Drupal (CVE-2016-3144)|%{tx.domain}|%{tx.mode}',phase:2,deny,status:403,log,t:'none'"
SecRule ARGS_POST:form_id "@within block_add_block_form block_admin_configure" \
	"chain,t:'none'"
SecRule ARGS:q|REQUEST_FILENAME "@contains /structure/block/" \
	"chain,t:'none',t:'urlDecodeUni',t:'normalisePath',t:'lowercase'"
SecRule ARGS_POST:css_class "@rx \"" \
	"t:'none',t:'urlDecodeUni'"

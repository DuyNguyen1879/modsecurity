# ---------------------------------------------------------------
# Sliqua WAF based on Comodo ModSecurity Rules
# Copyright (C) 2015 Sliqua Enterprise Hosting, Inc.
# Copyright (C) 2015 Comodo Security solutions All rights reserved.
# Please see the enclosed LICENCE file for full details.
# ---------------------------------------------------------------
# This is a FILE CONTAINING CHANGED or MODIFIED RULES FROM THE:
# OWASP ModSecurity Core Rule Set (CRS)
# Comodo Web Application Firewall
# ----------------------------------------------------------------

SecRule REQUEST_METHOD "@streq POST" \
	"id:230000,rev:1,chain,msg:'COMODO WAF: Brute Force Attack Identified from %{tx.real_ip} (%{tx.brute_force_block_counter} hits since last alert)',phase:1,block,t:'none'"
SecRule REQUEST_FILENAME "@pmFromFile userdata_login_pages" \
	"chain,t:'none'"
SecRule IP:BRUTE_FORCE_BLOCK "@eq 1" \
	"chain,setvar:'ip.brute_force_block_counter=+1'"
SecRule &IP:BRUTE_FORCE_BLOCK_FLAG "@eq 0" \
	"expirevar:'ip.brute_force_block_flag=60',setvar:'ip.brute_force_block_flag=1',setvar:'tx.brute_force_block_counter=%{ip.brute_force_block_counter}',setvar:'ip.brute_force_block_counter=0'"

SecRule REQUEST_METHOD "@streq POST" \
	"id:230001,rev:1,chain,phase:1,block,nolog,t:'none'"
SecRule REQUEST_FILENAME "@pmFromFile userdata_login_pages" \
	"chain,t:'none'"
SecRule IP:BRUTE_FORCE_BLOCK "@eq 1" \
	"setvar:'ip.brute_force_block_counter=+1'"

SecRule REQUEST_METHOD "!@streq POST" \
	"id:230002,rev:1,phase:5,pass,nolog,t:'none',skipAfter:'GENERIC_POST_BRUTEFORCE_END'"

SecRule REQUEST_FILENAME "!@pmFromFile userdata_login_pages" \
	"id:230003,rev:1,phase:5,pass,nolog,t:'none',skipAfter:'GENERIC_POST_BRUTEFORCE_END'"

SecRule IP:BRUTE_FORCE_BLOCK "@eq 1" \
	"id:230004,rev:1,phase:5,pass,nolog,t:'none',skipAfter:'GENERIC_POST_BRUTEFORCE_END'"

SecAction \
	"id:230005,phase:5,pass,setvar:'ip.brute_force_counter=+1',nolog,t:'none'"

SecRule IP:BRUTE_FORCE_COUNTER "@gt %{tx.brute_force_counter_threshold}" \
	"id:230006,rev:1,phase:5,pass,expirevar:'ip.brute_force_burst_counter=%{tx.brute_force_burst_time_slice}',setvar:'ip.brute_force_burst_counter=+1',setvar:'!ip.brute_force_counter',nolog,t:'none'"

SecRule IP:BRUTE_FORCE_BURST_COUNTER "@ge 2" \
	"id:230007,rev:1,msg:'COMODO WAF: Potential Brute Force Attack from %{tx.real_ip} - # of Request Bursts: %{ip.brute_force_burst_counter}',phase:5,pass,expirevar:'ip.brute_force_block=%{tx.brute_force_block_timeout}',setvar:'ip.brute_force_block=1',log,t:'none'"

SecMarker GENERIC_POST_BRUTEFORCE_END
SecRule REQUEST_FILENAME "@contains wp-login.php" \
	"id:230010,rev:2,chain,phase:2,pass,nolog,t:'none'"
SecRule REQUEST_METHOD "@streq POST" \
	"chain"
SecRule ARGS:log ".{0,}" \
	"chain"
SecRule &IP:PREVIOUS_USERNAME "@eq 0" \
	"setvar:'ip.previous_username=%{args.log}'"

SecRule REQUEST_FILENAME "@contains wp-login.php" \
	"id:230011,rev:2,chain,msg:'COMODO WAF: Multiple Username Violation: Too Many Usernames Submitted for Authentication.',phase:2,block,logdata:'Current Username: %{args.log}',t:'none'"
SecRule REQUEST_METHOD "@streq POST" \
	"chain"
SecRule &ARGS:log "!@eq 0" \
	"chain"
SecRule &IP:PREVIOUS_USERNAME "@eq 1" \
	"chain"
SecRule ARGS:log "!within %{ip.previous_username}" \
	"chain,expirevar:'ip.multiple_username_count=60',setvar:'ip.multiple_username_count=+1',setvar:'ip.previous_username=%{ip.previous_username}, %{args.log}'"
SecRule IP:MULTIPLE_USERNAME_COUNT "@gt 5"

SecRule REQUEST_FILENAME "@contains administrator" \
	"id:230020,rev:3,chain,phase:2,pass,nolog,t:'none'"
SecRule REQUEST_METHOD "@streq POST" \
	"chain"
SecRule &ARGS:username "!@eq 0" \
	"chain"
SecRule &IP:PREVIOUS_USERNAME "@eq 0" \
	"setvar:'ip.previous_username=%{args.username}'"

SecRule REQUEST_FILENAME "@contains administrator" \
	"id:230021,rev:3,chain,msg:'COMODO WAF: Multiple Username Violation: Too Many Usernames Submitted for Authentication.',phase:2,block,logdata:'Current Username: %{args.username}',t:'none'"
SecRule REQUEST_METHOD "@streq POST" \
	"chain"
SecRule ARGS:username ".{1,}" \
	"chain"
SecRule &IP:PREVIOUS_USERNAME "@eq 1" \
	"chain"
SecRule ARGS:username "!within %{ip.previous_username}" \
	"chain,expirevar:'ip.multiple_username_count=60',setvar:'ip.multiple_username_count=+1',setvar:'ip.previous_username=%{ip.previous_username}, %{args.name}'"
SecRule IP:MULTIPLE_USERNAME_COUNT "@gt 5"

SecRule REQUEST_METHOD "@streq POST" \
	"id:230030,rev:2,chain,phase:2,pass,nolog,t:'none'"
SecRule ARGS_GET:q "@streq node" \
	"chain"
SecRule ARGS_GET:destination "@streq node" \
	"chain"
SecRule &ARGS:name "!@eq 0" \
	"chain"
SecRule &IP:PREVIOUS_USERNAME "@eq 0" \
	"setvar:'ip.previous_username=%{args.name}'"

SecRule REQUEST_METHOD "@streq POST" \
	"id:230031,rev:2,chain,msg:'COMODO WAF: Multiple Username Violation: Too Many Usernames Submitted for Authentication.',phase:2,block,logdata:'Current Username: %{args.name}',t:'none'"
SecRule ARGS_GET:q "@streq node" \
	"chain"
SecRule ARGS_GET:destination "@streq node" \
	"chain"
SecRule ARGS:name ".{0,}" \
	"chain"
SecRule &IP:PREVIOUS_USERNAME "@eq 1" \
	"chain"
SecRule ARGS:name "!within %{ip.previous_username}" \
	"chain,expirevar:'ip.multiple_username_count=60',setvar:'ip.multiple_username_count=+1',setvar:'ip.previous_username=%{ip.previous_username}, %{args.name}'"
SecRule IP:MULTIPLE_USERNAME_COUNT "@gt 5"
